<!DOCTYPE html>
<html lang="ko">
<head>
    <title>끝말잇기 - 게임 룸 목록</title>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; padding-top: 50px; background-color: #f0f2f5; }
        .container { width: 90%; max-width: 600px; }
        .room-list { list-style: none; padding: 0; }
        .room-item { background: white; margin-bottom: 10px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .room-item a { text-decoration: none; color: #007bff; font-weight: bold; }
        .room-item span { color: #666; }
        button { padding: 10px 15px; font-size: 1rem; cursor: pointer; border-radius: 4px; border: none; background-color: #28a745; color: white; }
    </style>
</head>
<body>
<div class="container">
    <h1>게임 룸 목록</h1>
    <button id="create-room-btn">새로운 방 만들기</button>
    <ul id="room-list" class="room-list"></ul>
</div>
<script>
    const roomListEl = document.getElementById('room-list');
    const createRoomBtn = document.getElementById('create-room-btn');

    async function fetchRooms() {
        const response = await fetch('/api/rooms');
        const rooms = await response.json();
        roomListEl.innerHTML = ''; // 목록 비우기
        if (rooms) {
            rooms.forEach(room => {
                const li = document.createElement('li');
                li.className = 'room-item';
                // 변경: href="#"로 바꾸고, 방 정보를 data 속성에 저장합니다.
                li.innerHTML = `
                    <a href="#" data-room-id="${room.id}" data-room-name="${room.roomName}">방 #${room.id} - ${room.roomName}</a>
                    <span>${room.isStarted ? '게임 중' : '대기 중'} (${room.playerCount}명)</span>
                `;
                roomListEl.appendChild(li);
            });
        }
    }

    roomListEl.addEventListener('click', (e) => {
        const link = e.target.closest('a');
        if (link) {
            e.preventDefault(); // 링크의 페이지 이동 블록.

            const roomId = link.dataset.roomId;
            const roomName = link.dataset.roomName;

            const userName = prompt("게임에서 사용할 이름을 입력하세요:", "익명");

            // 사용자가 취소를 누르지 않은 경우에만 페이지를 이동.
            if (userName !== null) {
                window.location.href = `/room.html?id=${roomId}&roomName=${encodeURIComponent(roomName)}&name=${encodeURIComponent(userName || '익명')}`;
            }
        }
    });

    createRoomBtn.addEventListener('click', () => {
        // 방 생성 페이지로 이동
        window.location.href = '/create-room.html';
    });

    let pollingIntervalId = null; 

    function startPolling() {
        // 이미 폴링이 실행 중이면 중복 실행 방지
        if (pollingIntervalId) {
            clearInterval(pollingIntervalId);
        }
        pollingIntervalId = setInterval(fetchRooms, 500);
    }

    function stopPolling() {
        clearInterval(pollingIntervalId);
        pollingIntervalId = null;
    }

    // 페이지의 가시성 상태 변경을 감지하는 이벤트 리스너
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            console.log("탭이 비활성화되어 폴링을 중지합니다.");
            stopPolling();
        } else {
            console.log("탭이 활성화되어 목록을 갱신하고 폴링을 시작합니다.");
            fetchRooms();
            startPolling();
        }
    });

    fetchRooms();
    startPolling();
</script>
</body>
</html>